(function(){"use strict";const r={ragQueryUrl:"http://52.151.192.107:8000/query",ragIngestUrl:"http://52.151.192.107:8000/ingest",collection:"greycloud_main",streamDelay:30};class c{messagesContainer;inputField;sendButton;uploadButton;fileInput;state="CHAT";currentFormStep=0;formData={};isCollapsed=localStorage.getItem("weaver_collapsed")!=="false";signupSteps=[{field:"firstName",label:"First Name",validate:e=>/^[a-zA-Z]+$/.test(e)?null:"Please enter a valid name (letters only)."},{field:"lastName",label:"Last Name",validate:e=>/^[a-zA-Z]+$/.test(e)?null:"Please enter a valid name (letters only)."},{field:"email",label:"Email Address",validate:e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?null:"Please enter a valid email address."}];agentSteps=[{field:"firstName",label:"First Name",validate:e=>e.length>0?null:"First Name is required."},{field:"lastName",label:"Last Name",validate:e=>e.length>0?null:"Last Name is required."},{field:"contactNumber",label:"Contact No.",validate:e=>/^\d{10,15}$/.test(e)?null:"Please enter a valid contact number."},{field:"emailAddress",label:"Email Address",validate:e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?null:"Please enter a valid email address."},{field:"roseNumber",label:"Rose No.",validate:e=>e.length>0?null:"Rose Number is required."}];constructor(){console.log("[Weaver] Initializing Widget..."),this.init(),this.loadTheme()}async loadTheme(){try{const e=await fetch("/weaver/theme.json");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json(),s=document.documentElement;t.primary&&s.style.setProperty("--primary-color",t.primary),t.secondary&&s.style.setProperty("--secondary-color",t.secondary),t.bgDark&&s.style.setProperty("--bg-dark",t.bgDark),t.chatBg&&s.style.setProperty("--chat-bg",t.chatBg),t.sidebarGreen&&s.style.setProperty("--sidebar-green",t.sidebarGreen),t.buttonRadius&&s.style.setProperty("--button-radius",t.buttonRadius),t.buttonWidth&&s.style.setProperty("--button-width",t.buttonWidth),t.buttonHeight&&s.style.setProperty("--button-height",t.buttonHeight),t.widgetWidth&&s.style.setProperty("--widget-width",t.widgetWidth),t.widgetHeight&&s.style.setProperty("--widget-height",t.widgetHeight),t.collapsedHeight&&s.style.setProperty("--collapsed-height",t.collapsedHeight);const i=document.getElementById("weaver-header-title"),a=document.getElementById("weaver-header-subtitle");if(i&&t.headerTitle&&(i.textContent=t.headerTitle),a&&t.headerSubtitle&&(a.textContent=t.headerSubtitle),t.gradient&&Array.isArray(t.gradient)){const g=`linear-gradient(var(--angle), ${t.gradient.join(", ")})`;s.style.setProperty("--border-gradient",g)}const n=t.borderStyle||"multi",l=t.animateBorder!==!1,d=t.sidebarGreen||"#203a20";let o="";n==="multi"?o="conic-gradient(from 0deg, #4285F4, #9B51E0, #EB5757, #F2994A, #F2C94C, #27AE60, #4285F4)":n==="gradw"?o=`conic-gradient(from 0deg, ${d}, #ffffff, ${d})`:n==="gradb"&&(o=`conic-gradient(from 0deg, ${d}, #000000, ${d})`),o&&s.style.setProperty("--weaver-border-gradient",o),s.style.setProperty("--weaver-border-animation-def",l?"rotate 4s linear infinite":"none"),t.borderWidth&&s.style.setProperty("--weaver-border-width",t.borderWidth)}catch(e){console.error("Failed to load theme:",e)}}init(){let e=document.querySelector("#app");e||(e=document.createElement("div"),e.id="app",document.body.appendChild(e)),e.innerHTML=`
            <div id="weaver-widget" class="${this.isCollapsed?"collapsed":""}">
                <div id="weaver-content">
                    <div id="weaver-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span id="weaver-header-title">Weaver AI</span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; box-shadow: 0 0 8px #10b981;"></div>
                                <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                        </div>
                        <span id="weaver-header-subtitle" style="font-size: 11px; opacity: 0.7; font-weight: 400;">Universal Execution Agent</span>
                    </div>
                    <div id="weaver-messages"></div>
                    <div id="weaver-input-container">
                        <input type="file" id="weaver-file-input" style="display: none;" accept=".pdf,.txt,.docx">
                        <button id="weaver-upload" title="Upload Document">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        </button>
                        <input type="text" id="weaver-input" placeholder="Ask a question..." autocomplete="off">
                        <button id="weaver-send">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>
                </div>
            </div>
        `,this.messagesContainer=document.getElementById("weaver-messages"),this.inputField=document.getElementById("weaver-input"),this.sendButton=document.getElementById("weaver-send"),this.uploadButton=document.getElementById("weaver-upload"),this.fileInput=document.getElementById("weaver-file-input");const t=document.getElementById("weaver-header"),s=document.getElementById("weaver-widget");t&&s&&t.addEventListener("click",()=>{this.isCollapsed=!this.isCollapsed,localStorage.setItem("weaver_collapsed",String(this.isCollapsed)),this.isCollapsed?(s.classList.add("collapsed"),s.classList.remove("open-anim")):(s.classList.remove("collapsed"),s.classList.add("open-anim"),setTimeout(()=>s.classList.remove("open-anim"),800))}),this.sendButton.addEventListener("click",()=>this.handleSendMessage()),this.inputField.addEventListener("keypress",a=>{a.key==="Enter"&&this.handleSendMessage()}),this.uploadButton.addEventListener("click",()=>this.fileInput.click()),this.fileInput.addEventListener("change",()=>this.handleFileUpload()),this.loadMessages(),this.checkPageContext();const i=history.pushState;history.pushState=(...a)=>{i.apply(history,a),this.checkPageContext()},window.addEventListener("popstate",()=>this.checkPageContext())}checkPageContext(){if(window.location.href.includes("/agents/agent-customer")&&this.state==="CHAT"){if(sessionStorage.getItem("weaver_suppress_greeting")==="true"){sessionStorage.removeItem("weaver_suppress_greeting");return}this.messagesContainer.innerText.includes("register a new agent on this page")||this.appendMessage("I see you're in the Agent Portal. Would you like to register a new agent on this page?",!1)}}appendMessage(e,t,s=!1){const i=document.createElement("div");if(i.className=`message ${t?"user-message":"agent-message"}`,t)i.textContent=e,this.messagesContainer.appendChild(i);else{if(this.messagesContainer.appendChild(i),s)return this.streamText(i,e);this.renderAgentContent(i,e)}this.scrollToBottom(),s||this.saveMessages()}saveMessages(){const e=Array.from(this.messagesContainer.querySelectorAll(".message")).map(t=>({html:t.innerHTML,isUser:t.classList.contains("user-message")}));localStorage.setItem("weaver_messages",JSON.stringify(e))}loadMessages(){const e=localStorage.getItem("weaver_messages");if(e)try{JSON.parse(e).forEach(s=>{const i=document.createElement("div");i.className=`message ${s.isUser?"user-message":"agent-message"}`,i.innerHTML=s.html,s.isUser||i.querySelectorAll(".weaver-link").forEach(a=>{a.addEventListener("click",n=>{const l=n.currentTarget.getAttribute("data-url");l&&(n.preventDefault(),this.triggerNavigation(l))})}),this.messagesContainer.appendChild(i)})}catch{this.appendMessage("Hello! I'm your Weaver Agent. How can I help today?",!1)}else this.appendMessage("Hello! I'm your Weaver Agent. You can ask me about the system or I can guide you through actions. How can I help today?",!1);this.scrollToBottom()}async streamText(e,t){let s="";const i=t.split("");for(const a of i)s+=a,this.renderAgentContent(e,s),this.scrollToBottom(),await new Promise(n=>setTimeout(n,r.streamDelay));this.saveMessages(),this.state==="CHAT"&&t.toLowerCase().includes("navigate")}renderAgentContent(e,t){let s=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(i,a,n)=>`<a class="weaver-link" data-url="${n}">${a}</a>`);s=s.replace(/`?((?:\/)?dashboard\/[a-zA-Z0-9\/\(\)\-\._]+)`?/g,(i,a)=>`<a class="weaver-link" data-url="${a.startsWith("/")?a:`/${a}`}">${a}</a>`),e.innerHTML=s,e.querySelectorAll(".weaver-link").forEach(i=>{i.addEventListener("click",a=>{const n=a.currentTarget.getAttribute("data-url");n&&(a.preventDefault(),this.triggerNavigation(n))})})}scrollToBottom(){this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}showTypingIndicator(){const e=document.createElement("div");e.id="weaver-typing",e.className="typing-indicator",e.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>',this.messagesContainer.appendChild(e),this.scrollToBottom()}removeTypingIndicator(){const e=document.getElementById("weaver-typing");e&&e.remove()}async handleSendMessage(){const e=this.inputField.value.trim();if(!e)return;this.appendMessage(e,!0),this.inputField.value="";const t=document.getElementById("weaver-widget");if(t&&t.classList.add("submit-anim"),this.state==="FORM_SIGNUP"||this.state==="FORM_AGENT"){this.handleFormStep(e);return}if(window.greyCloudHandler){this.showTypingIndicator();try{const s=await window.greyCloudHandler(e);this.removeTypingIndicator(),s&&s.response?this.appendMessage(s.response,!1,!0):typeof s=="string"&&this.appendMessage(s,!1,!0)}catch{this.removeTypingIndicator(),this.appendMessage("Error: GreyCloud handler failed.",!1)}finally{t&&t.classList.remove("submit-anim")}return}if(e.toLowerCase().includes("add an agent")){this.appendMessage("I can help you add a new agent. Would you like to go to the [Agent Portal](/agents/agent-customer) now?",!1);return}if(e.toLowerCase()==="yes"){const s=this.messagesContainer.innerText;if(s.includes("register a new agent on this page")||s.includes("register a new agent?")){this.startAgentForm();return}if(s.includes("Agent Portal")){this.appendMessage("Great! Navigating you now...",!1),this.triggerNavigation("/agents/agent-customer");return}if(this.state==="RELOAD_CONFIRM"){this.appendMessage("Reloading page...",!1),sessionStorage.setItem("weaver_suppress_greeting","true"),setTimeout(()=>{window.location.reload()},500);return}}await this.queryRAG(e)}async queryRAG(e){this.showTypingIndicator(),this.inputField.disabled=!0,this.sendButton.disabled=!0,this.uploadButton.disabled=!0;try{const s=await(await fetch(r.ragQueryUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer your_api_token_here"},body:JSON.stringify({query:e,k:5,collection:r.collection})})).json();this.removeTypingIndicator();let i=s.answer||s.response||s.Message||"I'm sorry, I couldn't process that query.";e.toLowerCase().includes("agent")?i+=`

I can take you to the Agents page. Would you like to go to [Agent Portal](/agents/agent-customer)?`:(e.toLowerCase().includes("how")||e.toLowerCase().includes("work"))&&(i+=`

I can show you the technical architecture in our [Docs Page](/docs). Would you like to go there?`),await this.appendMessage(i,!1,!0)}catch{this.removeTypingIndicator(),this.appendMessage("Error: Failed to connect to RAG sandbox.",!1)}finally{this.inputField.disabled=!1,this.sendButton.disabled=!1,this.uploadButton.disabled=!1,this.inputField.focus();const t=document.getElementById("weaver-widget");t&&t.classList.remove("submit-anim")}}triggerNavigation(e){window.weaverNavigate?window.weaverNavigate(e):console.warn("Navigation hook 'window.weaverNavigate' not found on host site.")}startAgentForm(){this.state="FORM_AGENT",this.currentFormStep=0,this.formData={},this.appendMessage("Great! Let's register a new agent. What is the agent's **First Name**?",!1)}handleFormStep(e){const t=this.state==="FORM_AGENT"?this.agentSteps:this.signupSteps,s=t[this.currentFormStep],i=s.validate(e);if(i){this.appendMessage(i,!1);return}if(this.formData[s.field]=e,this.currentFormStep++,this.currentFormStep<t.length){const a=t[this.currentFormStep];this.appendMessage(`Got it. Now, what is the **${a.label}**?`,!1)}else this.completeForm()}async completeForm(){const e=this.state==="FORM_AGENT";this.state="CHAT",e?(this.appendMessage("Perfect. Submitting agent registration to Avis API...",!1),await this.submitAgentToAvis()):(this.appendMessage(`Perfect! I've registered you with the following details:

**Name:** ${this.formData.firstName} ${this.formData.lastName}
**Email:** ${this.formData.email}

Is there anything else I can help you with?`,!1,!0),this.triggerNavigation("Form Completion"))}async submitAgentToAvis(){this.showTypingIndicator();const e="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL2VtYWlsYWRkcmVzcyI6Im5qaW51a2ltYW5pQGdtYWlsLmNvbSIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWUiOiJOamludSIsImV4cCI6MTc3MDAzNDE0MCwiaXNzIjoiYXBpZ3ctYXctZXUud2VibWV0aG9kcy5pbyIsImF1ZCI6ImFwaWd3LWF3LWV1LndlYm1ldGhvZHMuaW8ifQ.Wosddx4eEIp4NcODS-KTkbujJkXa0FIHjtvnLQDNyoU";try{const t={...this.formData,password:"0",isNew:!0,domain:"9b8cfb28-a153-4923-887c-08dccb57652a"},s=await fetch("https://avis-dev-api.azurewebsites.net/User/registeragent",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(t)}),i=await s.json();this.removeTypingIndicator(),s.ok?(this.appendMessage(`✅ Agent registered successfully!

**Response:** ${JSON.stringify(i)}`,!1,!0),this.state="RELOAD_CONFIRM",setTimeout(()=>{this.appendMessage("Would you like to reload the page to see the changes?",!1)},1500)):(this.appendMessage(`❌ Registration failed.

**Error:** ${i.Message||i.error||"Unknown error"}`,!1),this.state="CHAT")}catch{this.removeTypingIndicator(),this.appendMessage("❌ Error: Failed to connect to Avis API.",!1)}}async handleFileUpload(){const e=this.fileInput.files?.[0];if(!e)return;this.appendMessage(`Uploading: ${e.name}...`,!0),this.showTypingIndicator(),this.inputField.disabled=!0,this.sendButton.disabled=!0,this.uploadButton.disabled=!0;const t=new FormData;t.append("file",e),t.append("document_id",`${Date.now()}_${e.name}`),t.append("collection",r.collection);const s=document.getElementById("weaver-widget");s&&s.classList.add("submit-anim");try{const i=await fetch(r.ragIngestUrl,{method:"POST",headers:{Authorization:"Bearer your_api_token_here"},body:t}),a=await i.json();this.removeTypingIndicator(),i.ok?this.appendMessage(`✅ File ingested successfully!

**Response:** ${JSON.stringify(a)}`,!1,!0):this.appendMessage(`❌ Upload failed.

**Error:** ${a.detail||a.error||"Unknown error"}`,!1)}catch{this.removeTypingIndicator(),this.appendMessage("❌ Error: Failed to connect to RAG ingest service.",!1)}finally{this.inputField.disabled=!1,this.sendButton.disabled=!1,this.uploadButton.disabled=!1,this.fileInput.value="";const i=document.getElementById("weaver-widget");i&&i.classList.remove("submit-anim")}}}new c})();
